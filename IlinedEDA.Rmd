---
title: "Untitled"
author: "Naydelin Hernandez Vargas, C03795"
date: "2025-10-13"
output: html_document
---
```{r}
# install.packages(c("tidyverse","lubridate","skimr","GGally","patchwork","ISOweek"))

library(tidyverse)
library(lubridate)
library(skimr)
library(GGally)
library(patchwork)
library(ISOweek)

```

```{r}
datos <- "C:/Users/nayde/OneDrive/Desktop/Series de tiempo/anteproyecto/ILINet.csv"

col_names <- c(
  "region_type","region","year","week",
  "pct_weighted_ili","pct_unweighted_ili",
  "age_0_4","age_25_49","age_25_64","age_5_24","age_50_64","age_65",
  "ili_total","num_providers","total_patients"
)


```

```{r}
ilin <- readr::read_delim(
  datos,
  delim = ";",
  skip = 2,                 # salta titulo y linea de encabezado 
  col_names = col_names,
  na = c("X","x","","NA"),  # 'X' aparece en los datos tratarlo como NA
  show_col_types = FALSE
)

#
glimpse(ilin)

# Convertir tipos numericos donde corresponde 
num_cols <- c("pct_weighted_ili","pct_unweighted_ili",
              "age_0_4","age_25_49","age_25_64","age_5_24","age_50_64","age_65",
              "ili_total","num_providers","total_patients")

ilin <- ilin |>
  mutate(
    across(all_of(num_cols), ~ suppressWarnings(as.numeric(.x))),
    year = as.integer(year),
    week = as.integer(week)
  )

```
```{r}
ilin <- ilin |>
  mutate(
    iso_str = sprintf("%d-W%02d-1", year, week),        
    date = ISOweek::ISOweek2date(iso_str) #para manejar las fechas 
  ) |>
  arrange(date)

range(ilin$date, na.rm = TRUE) #rango temporal
ilin |>
  count(year, week) |>
  filter(n > 1) # duplicados (si hay)
```

##  nulos
```{r}
ilin |>
  summarise(across(everything(), ~sum(is.na(.)))) |>
  print()

```
##v tasas por grupo etario (visitas ILI / total pacientes)


```{r}
ilin <- ilin |>
  mutate(
    rate_ili_total    = ili_total / total_patients,
    rate_age_0_4      = age_0_4   / total_patients,
    rate_age_5_24     = age_5_24  / total_patients,
    rate_age_25_49    = age_25_49 / total_patients,
    rate_age_25_64    = age_25_64 / total_patients,
    rate_age_50_64    = age_50_64 / total_patients,
    rate_age_65       = age_65    / total_patients
  )

```
Suponiendo que  columnas age y ili_total son recuentos (visitas ILI),
 y total_patients es total de pacientes (todas las causas).  

## Resumen
```{r}
skim(ilin)

ilin |>
  summarise(
    n = n(),
    across(c(pct_weighted_ili, pct_unweighted_ili, rate_ili_total),
           list(min = ~min(.x, na.rm = TRUE),
                q25 = ~quantile(.x, .25, na.rm = TRUE),
                mean = ~mean(.x, na.rm = TRUE),
                med = ~median(.x, na.rm = TRUE),
                q75 = ~quantile(.x, .75, na.rm = TRUE),
                max = ~max(.x, na.rm = TRUE),
                sd  = ~sd(.x, na.rm = TRUE)), .names = "{.col}_{.fn}")
  ) |>
  pivot_longer(-n, names_to = "stat", values_to = "value") |>
  print(n = 100)


```
 ## Outliers
```{r}
is_outlier <- function(x){
  q1 <- quantile(x, .25, na.rm = TRUE)
  q3 <- quantile(x, .75, na.rm = TRUE)
  iqr <- q3 - q1
  (x < q1 - 1.5*iqr) | (x > q3 + 1.5*iqr)
}

ilin_flag <- ilin |>
  mutate(
    out_w = is_outlier(pct_weighted_ili),
    out_u = is_outlier(pct_unweighted_ili)
  )

ilin_flag |>
  filter(out_w | out_u) |>
  select(date, year, week, pct_weighted_ili, pct_unweighted_ili) |>
  arrange(date) |>
  print(n = 50)

```
 
 estas semanas son mucho más altas que el resto del año pero no necesariamente son outliers
 
 ##Visualizacion temporal
 
```{r}
theme_set(theme_minimal(base_size = 12))

p_w <- ggplot(ilin, aes(date, pct_weighted_ili)) +
  geom_line() +
  labs(title = "% ILI ponderado (semanal)", x = NULL, y = "%")

p_u <- ggplot(ilin, aes(date, pct_unweighted_ili)) +
  geom_line() +
  labs(title = "% ILI no ponderado (semanal)", x = NULL, y = "%")

(p_w | p_u)

# Tasas por edades a lo largo del tiempo (facetas)
rates_long <- ilin |>
  select(date, starts_with("rate_age_")) |>
  pivot_longer(-date, names_to = "age_group", values_to = "rate") |>
  mutate(age_group = recode(age_group,
                            rate_age_0_4   = "0-4",
                            rate_age_5_24  = "5-24",
                            rate_age_25_49 = "25-49",
                            rate_age_25_64 = "25-64",
                            rate_age_50_64 = "50-64",
                            rate_age_65    = "65+"))

ggplot(rates_long, aes(date, rate)) +
  geom_line() +
  facet_wrap(~ age_group, ncol = 3, scales = "free_y") +
  labs(title = "Tasa ILI por grupo etario (visitas ILI / total pacientes)",
       x = NULL, y = "Proporción")

```
Podemos observar estacionalidad el porcentaje de consultas por ILI aumenta de forma sostenida hasta alcanzar un maximo a comienzos del año, presenta un doble pico cercano en semanas contiguas y luego desciende gradualmente hacia un minimo
La columna de edad 25-64 esta vacia, se puede eliminar 
# Histogramas y boxplots
```{r}
p_hist <- function(var, xlab){
  ggplot(ilin, aes(x = .data[[var]])) +
    geom_histogram(bins = 25) +
    labs(title = paste("Histograma de", xlab), x = xlab, y = "Frecuencia")
}

p_box <- function(var, ylab){
  ggplot(ilin, aes(y = .data[[var]])) +
    geom_boxplot() +
    labs(title = paste("Boxplot de", ylab), x = NULL, y = ylab)
}

(p_hist("pct_weighted_ili","% ILI ponderado") | p_box("pct_weighted_ili","% ILI ponderado")) /
  (p_hist("pct_unweighted_ili","% ILI no ponderado") | p_box("pct_unweighted_ili","% ILI no ponderado"))

```
 Los boxplots muestran outliers altos, semanas pico donde la actividad ILI fue inusualmente elevada respecto al resto del año.
 
```{r}


corr_vars <- ilin |>
  select(pct_weighted_ili, pct_unweighted_ili,
         rate_ili_total, starts_with("rate_age_")) |>
  drop_na()

if (nrow(corr_vars) > 2) {
  GGally::ggcorr(corr_vars, label = TRUE)
}

# Dispersión entre % ponderado vs no ponderado
ggplot(ilin, aes(pct_unweighted_ili, pct_weighted_ili)) +
  geom_point(alpha = .7) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(title = "% ILI ponderado vs no ponderado", x = "% no ponderado", y = "% ponderado")

```
Las series ponderada y no ponderada presentan correlacion
el ajuste por ponderacion apenas cambia el valor semanal, incluir ambas en el mismo modelo/matriz (aportan informacion redundante, multicolinealidad).

## ACF Y PACF
```{r}
df <- ilin |>
  arrange(date) |>
  transmute(date,
            y = as.numeric(pct_weighted_ili)) |>
  filter(is.finite(y))

y_ts <- ts(df$y, start = c(year(min(df$date)), 1), frequency = 52) #frecuencia semanal, inicia semana 1

plot_acf_pacf <- function(x, main = "", max_lag = 156) {
  old <- par(no.readonly = TRUE); on.exit(par(old))
  par(mfrow = c(1,2))
  acf(x, na.action = na.pass, lag.max = max_lag, main = paste("ACF -", main))
  pacf(x, na.action = na.pass, lag.max = max_lag, main = paste("PACF -", main))
}

plot_acf_pacf(y_ts, main = "pct_weighted_ili (niveles)")

```
la serie en niveles parace no ser estacionaria, aplicar una diferencia 
```{r}
#  la serie y la primera diferencia 
df <- ilin |>
  arrange(date) |>
  transmute(date, y = as.numeric(pct_weighted_ili)) |>  #solo se esta haciendo por ahora con pct_weighted_ili
  filter(is.finite(y))



stopifnot(nrow(df) >= 2)  #  al menos 2 puntos para d=1

y_ts <- ts(df$y,
           start = c(year(min(df$date, na.rm = TRUE)), 1),  
           frequency = 52)

y_d1 <- diff(y_ts, 1)  #dif

#
plot_acf_pacf <- function(x, main = "", max_lag = 156) {
  old <- par(no.readonly = TRUE); on.exit(par(old))
  x <- as.numeric(x); x <- x[is.finite(x)]
  lag_max <- min(max_lag, max(1, length(x) - 1))
  par(mfrow = c(1,2))
  acf(x,  lag.max = lag_max, na.action = na.pass, main = paste("ACF -",  main))
  pacf(x, lag.max = lag_max, na.action = na.pass, main = paste("PACF -", main))
}


par(mfrow = c(1,1))
plot(y_d1, type = "l", main = "Primera diferencia d=1", ylab = " dif y", xlab = "")

plot_acf_pacf(y_d1, main = " (d=1)")

```
 ACF: pico grande en lag 1, luego cae rapido y demas rezagos estan dentro de bandas.

PACF: pico en lag 1 y cae lentamente

Probar MA(1) en serie diferenciada, 
ARIMA(0,1,1) ARIMA(1,1,0) ARIMMA(1,1,1)

```{r}
#usare forecast otra vez
fit_011 <- Arima(y_ts, order = c(0,1,1)) #serie semanal
fit_110 <- Arima(y_ts, order = c(1,1,0))
fit_111 <- Arima(y_ts, order = c(1,1,1))

# Comparacion BIC/AIC
tbl_ic <- tibble::tibble(
  modelo = c("ARIMA(0,1,1)", "ARIMA(1,1,0)", "ARIMA(1,1,1)"),
  BIC    = c(BIC(fit_011),   BIC(fit_110),   BIC(fit_111)),
  AIC    = c(AIC(fit_011),   AIC(fit_110),   AIC(fit_111))
) |>
  dplyr::mutate(
    delta_BIC = BIC - min(BIC),
    delta_AIC = AIC - min(AIC)
  )

# ordenado por BIC
tbl_ic |> dplyr::arrange(BIC) |> print()

#ordenadi por AIC
tbl_ic |> dplyr::arrange(AIC) |> print()

best <- fit_011  #ranquea 
summary(best)
forecast::checkresiduals(best)  # ACF/PACF  y Ljung–Box


```


